---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki-stack
  namespace: observability
spec:
  chart:
    spec:
      version: "~>2.9"
  values:
    loki:
      enabled: true
      isDefault: false # To avoid clashing with Prometheus, the default data source
      serviceMonitor:
        enabled: true
        interval: 30s
        additionalLabels:
          tier: cluster
      persistence:
        enabled: true
      serviceAccount:
        annotations:
          "eks.amazonaws.com/role-arn": "arn:aws:iam::537928299818:role/simple-cluster-loki-storage"
      config:
        schema_config:
          configs:
          # Arbitrary date in the past
          - from: "2023-01-01"
            store: boltdb-shipper
            object_store: s3
            schema: v11
            index:
              prefix: index_
              period: 24h
        storage_config:
          boltdb_shipper:
            active_index_directory: /loki/index
            cache_location: /loki/index_cache
            shared_store: s3
            cache_ttl: 24h
          aws:
            s3: s3://eu-north-1/loki-storage-simple-cluster-x7g9k3
            s3forcepathstyle: true
        compactor:
          working_directory: /loki/compactor
          shared_store: s3
          compaction_interval: 5m
    promtail:
      enabled: true
      serviceMonitor:
        enabled: true
        interval: 30s
        additionalLabels:
          tier: cluster
    fluent-bit:
      enabled: false
    grafana:
      enabled: false
    prometheus:
      enabled: false
